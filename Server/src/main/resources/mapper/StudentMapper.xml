<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.student.mapper.StudentMapper">

    <resultMap id="StudentWithDetailsMap" type="com.student.entity.Student">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="student_no" property="studentNo"/>
        <result column="class_id" property="classId"/>
        <result column="gender" property="gender"/>
        <result column="birth_date" property="birthDate"/>
        <result column="address" property="address"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        
        <association property="user" javaType="com.student.entity.User">
            <id column="user_id" property="id"/>
            <result column="username" property="username"/>
            <result column="real_name" property="realName"/>
            <result column="email" property="email"/>
            <result column="phone" property="phone"/>
            <result column="role" property="role"/>
            <result column="status" property="status"/>
        </association>
        
        <association property="studentClass" javaType="com.student.entity.Class">
            <id column="class_id" property="id"/>
            <result column="class_name" property="className"/>
            <result column="major" property="major"/>
            <result column="grade" property="grade"/>
            <result column="enroll_year" property="enrollYear"/>
        </association>
    </resultMap>

    <select id="selectStudentsWithDetails" resultMap="StudentWithDetailsMap">
        SELECT 
            s.id, s.user_id, s.student_no, s.class_id, s.gender, s.birth_date, s.address,
            s.create_time, s.update_time,
            u.username, u.real_name, u.email, u.phone, u.role, u.status,
            c.class_name, c.major, c.grade, c.enroll_year
        FROM student s
        LEFT JOIN user u ON s.user_id = u.id
        LEFT JOIN class c ON s.class_id = c.id
        WHERE 1=1
        <if test="studentNo != null and studentNo != ''">
            AND s.student_no LIKE CONCAT('%', #{studentNo}, '%')
        </if>
        <if test="realName != null and realName != ''">
            AND u.real_name LIKE CONCAT('%', #{realName}, '%')
        </if>
        <if test="classId != null">
            AND s.class_id = #{classId}
        </if>
        <if test="gender != null">
            AND s.gender = #{gender}
        </if>
        ORDER BY s.student_no
    </select>

    <select id="selectStudentWithDetails" resultMap="StudentWithDetailsMap">
        SELECT 
            s.id, s.user_id, s.student_no, s.class_id, s.gender, s.birth_date, s.address,
            s.create_time, s.update_time,
            u.username, u.real_name, u.email, u.phone, u.role, u.status,
            c.class_name, c.major, c.grade, c.enroll_year
        FROM student s
        LEFT JOIN user u ON s.user_id = u.id
        LEFT JOIN class c ON s.class_id = c.id
        WHERE s.id = #{id}
    </select>

    <select id="selectStudentsByClassId" resultMap="StudentWithDetailsMap">
        SELECT 
            s.id, s.user_id, s.student_no, s.class_id, s.gender, s.birth_date, s.address,
            s.create_time, s.update_time,
            u.username, u.real_name, u.email, u.phone, u.role, u.status
        FROM student s
        LEFT JOIN user u ON s.user_id = u.id
        WHERE s.class_id = #{classId}
        ORDER BY s.student_no
    </select>

    <update id="batchUpdateClassId">
        UPDATE student
        SET class_id = #{classId}, update_time = NOW()
        WHERE id IN
        <foreach collection="studentIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <select id="findStudentsByAgeRange" resultType="com.student.entity.Student">
        SELECT * FROM student
        WHERE birth_date BETWEEN 
            DATE_SUB(CURDATE(), INTERVAL #{maxAge} YEAR) 
            AND DATE_SUB(CURDATE(), INTERVAL #{minAge} YEAR)
        ORDER BY birth_date DESC
    </select>

</mapper>
